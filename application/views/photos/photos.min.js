!function(t){t.photos={init:function(){t("#file-upload").submit(function(e){for(e.preventDefault(),num=t("#file-select").prop("files").length,t("#notifier").show(),t("#file-upload").hide(),t("#notifier-text").html("Loading your images..."),i=0;num>i;i++)outer=t("<div/>"),t("<p/>").append(t("<span/>").html("0")).append("<span/>").appendTo(outer),container=t("<div/>").prependTo(outer),t("<img/>").addClass("blank").appendTo(container),t("#image-previews").append(outer);0==num||(window.files=t("#file-select").prop("files"),window.reader=new FileReader,window.reader.onload=t.photos.loaded,window.n=0,reader.readAsDataURL(files[0]))}),t.photos.load_basket(),t.photos.add_to_basket(),t(".update-cart").click(function(e){e.preventDefault(),t.photos.update_totals()}),t(".status-update").change(function(e){v=t(this).val(),option=t(this),o_id=t(this).siblings("input[name=oid]").val(),console.log(e),t.ajax({type:"POST",url:script_url+"photos/change_status",data:{order_id:o_id,status:v},error:function(){t.common.notify("Status could not be changed")},success:function(){option.parent().prev("h3").children(".stat").html(option.children("option[value="+v+"]").html())}})}),t(".photo-link").click(function(e){e.preventDefault(),photo=t(this),container=t("<div/>").append('<div class="photo-preview"><div class="prev"/><div class="next"/><div class="tag"/><div class="close"/><div class="download"/><div class="open"/></div><div class="side-bar"/>').addClass("photo-preview-container").appendTo("body"),t(".side-bar").append('<div class="uploader"><div class="user-icon"/><div class="name-date"><h3 class="name"/><p class="date"/></div></div><div class="tagged-info"/>'),cover=t("<div/>").addClass("photo-cover").appendTo("body"),t(".photo-preview").children("div").addClass("hover-icon"),t(".photo-cover, .close").click(function(){t.photos.closeScreen()}),t(".next").click(function(){t.photos.next_photo()}),t(".prev").click(function(){t.photos.prev_photo()}),t(".tag").click(function(){t(this).hasClass("untag")?t.photos.end_tag():t.photos.start_tag()}),t(".download").click(function(){url=t(".photo-preview").css("background-image"),url=url.substr(4,url.length-5);var e=t("<a>").attr("href",url).attr("download",t("#album-name").html()+".jpg").appendTo("body");e[0].click(),e.remove()}),t(".open").click(function(){url=t(".thumb").eq(n).parent().attr("href"),window.location.href=url}),t(".photo-preview").attr("value",photo.parent().index()),t.photos.reload_photo(),container.css("top",t(window).height()/2-container.height()/2+t(window).scrollTop()),cover.css("height",t(document).height()),container.css("left",t(window).width()/2-container.width()/2),t(".photo-preview").on({mouseenter:function(){container.addClass("hovering")},mouseleave:function(){container.removeClass("hovering")},mousemove:function(e){o=t(".photo-preview").offset(),d_x=t.photos.screen_to_db_x(e.pageX-o.left),d_y=t.photos.screen_to_db_y(e.pageY-o.top),minD=1e3,t(".photo-preview-container .list-of-tagged").children("p").each(function(){xx=parseFloat(t(this).attr("x")),yy=parseFloat(t(this).attr("y")),d=Math.pow(xx-d_x,2)+Math.pow(yy-d_y,2),minD>d&&(minD=d,ind=t(this).index())}),100>minD?(p=t(".photo-preview-container .list-of-tagged").children("p").eq(ind),t.photos.show_tag(p)):t.photos.hide_tag()}})}),t(document).unbind("keydown"),t(document).keydown(function(e){t(".photo-cover").length>0&&(27==e.keyCode?(e.preventDefault(),t.photos.closeScreen()):37==e.keyCode?(e.preventDefault(),t.photos.prev_photo()):39==e.keyCode&&(e.preventDefault(),t.photos.next_photo()))}),t(".rotate-photo, .edit-rotate").click(function(e){e.preventDefault(),button=t(this),is_img=button.hasClass("rotate-photo"),is_img?(img=t("#image-container").children("img"),p_id=t("#photo-id").html(),link=img.attr("src"),img.attr("src",t("#spinner-link").html())):(img=button.parent("div").siblings("a").children("div"),p_id=button.siblings(".photo-id").html(),link=img.css("background-image"),img.css("background-image","url("+t("#spinner-link").html()+")"),"undefined"==typeof img.attr("value")&&img.attr("value",link.substr(4).slice(0,-1))),t.ajax({type:"POST",url:script_url+"photos/rotate_photo",data:{photo_id:p_id,angle:button.hasClass("alt")?"90":"-90"},error:function(){is_img?img.attr("src",link):img.css("background-image",link),t.common.notify("This photo could not be rotated")},success:function(){d=new Date,link=img.attr("value")+"?t="+d.getTime(),is_img?img.attr("src",link):img.css("background-image","url("+link+")")}})}),t(".delete-photo, .edit-delete").click(function(e){e.preventDefault();var o=t("<div />").addClass("delete-conf-box");o.html("Are you sure you want to delete this photo?<br />"),button=t(this),is_img=button.hasClass("delete-photo"),p_id=is_img?t("#photo-id").html():button.siblings(".photo-id").html(),o.dialog({resizable:!1,draggable:!1,modal:!0,title:"Confirm Delete",buttons:{Delete:function(){t.ajax({type:"POST",url:script_url+"photos/delete_photo",data:{photo_id:p_id},error:function(){t.common.notify("This photo could not be removed")},success:function(){is_img?t("#back_link").click():button.closest(".photo-container").remove()}}),t(this).dialog("close")},Cancel:function(){t(this).dialog("close")}}})}),t(".delete-album").click(function(e){e.preventDefault();var o=t("<div />").addClass("delete-conf-box");o.html("Are you sure you want to delete this album, and all of the photos in it?<br />"),o.dialog({resizable:!1,draggable:!1,modal:!0,title:"Confirm Delete",buttons:{Delete:function(){t.ajax({type:"POST",url:script_url+"photos/delete_album",data:{a_id:t("#album-id").html()},error:function(){t.common.notify("This album could not be removed")},success:function(){t("#back_link").click()}}),t(this).dialog("close")},Cancel:function(){t(this).dialog("close")}}})}),t("input[name=watermark]").change(function(){t(this).is(":checked")?(t(".watermark-options").show(),t("#custom-text").prop("disabled","custom-watermark-option"!==t("input[name=watermark-options]:checked").val())):t(".watermark-options").hide()}),t("input[name=watermark-options]").change(function(){t("#custom-text").prop("disabled","custom-watermark-option"!==t(this).val())})},loaded:function(e){window.n++,t(".blank").eq(0).removeClass("blank").addClass("loaded").attr("src",e.target.result),window.n<num?window.reader.readAsDataURL(window.files[window.n]):(t("#notifier-text").html("Uploading your images..."),t.photos.upload())},upload:function(e){if(num_active=t(".uploading").length,!(num_active>2)){if(0==t(".loaded").length)return void(0==t(".uploading").length&&(t("#notifier-text").html("Done!"),t("#spinning").hide(),t("#album-link").click()));e=t(".loaded").eq(0),e.removeClass("loaded").addClass("uploading"),e.parent().siblings("p").addClass("animating"),src=e.attr("src").substring(23),console.log(src.length),parts=src.match(/.{1,1000000}/g),unique=t.photos.make_unique(),e.attr("unique",unique),t.photos.upload_part(e,parts,0,unique),setTimeout(function(){t.photos.upload()},500)}},upload_part:function(e,o,a,n){t.ajax(a<o.length?{type:"POST",url:script_url+"photos/upload_part",data:{uid:n,n:a,string:o[a]},error:function(){e.parent().siblings("p").removeClass("animating").addClass("failed"),e.parent().siblings("p").children("span").eq(0).html("")},success:function(){e.parent().siblings("p").children("span").eq(0).html(Math.round(100*(a+1)/o.length)),e.parent().siblings("p").children("span").eq(1).width(200*(a+1)/o.length),t.photos.upload_part(e,o,a+1,n)}}:{type:"POST",url:script_url+"photos/photo_complete",data:{uid:n,n:a,aid:t("#album-id").html(),watermark:t("input[name=watermark]").is(":checked")?1:0,watermarktype:t("input[name=watermark-options]:checked").parent().index(),watermarktext:t("#custom-text").val()},error:function(){e.parent().siblings("p").removeClass("animating").addClass("failed"),e.parent().siblings("p").children("span").eq(0).html(""),setTimeout(function(){t.photos.upload()},500)},success:function(){setTimeout(function(){t.photos.upload()},500),e.removeClass("uploading").addClass("done"),e.parent().siblings("p").removeClass("animating").addClass("done")}})},make_unique:function(){for(var t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;50>o;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},closeScreen:function(){t(".photo-cover, .photo-preview-container").remove()},next_photo:function(){console.log("next"),n=parseInt(t(".photo-preview").attr("value"))+1,n==t(".photo-container").length&&(n=0),t(".photo-preview").attr("value",n),t.photos.reload_photo()},prev_photo:function(){n=parseInt(t(".photo-preview").attr("value")),0==n&&(n=t(".photo-container").length),t(".photo-preview").attr("value",n-1),t.photos.reload_photo()},reload_photo:function(){n=t(".photo-preview").attr("value"),t(".photo-preview").css("background-image","url("+t(".thumb").eq(n).attr("image")+")"),t(".photo-preview-container .side-bar .uploader .user-icon").css("background-image","url("+t(".thumb").eq(n).children(".uploader-icon").html()+")"),t(".photo-preview-container .side-bar .uploader .name-date .name").html(t(".thumb").eq(n).children(".uploader-name").html()),t(".photo-preview-container .side-bar .uploader .name-date .date").html(t(".thumb").eq(n).children(".date").html()),t(".photo-preview-container .side-bar .tagged-info").html(t(".thumb").eq(n).children(".uploader-tagged").html()),t.photos.hover_remove(),t.photos.end_tag(),t.photos.hide_tag(),t.photos.add_to_basket(),t.photos.load_basket()},basket_animate:function(e){t(".basket-num").hasClass("basket-num-flash")?t(".basket-num").removeClass("basket-num-flash"):t(".basket-num").addClass("basket-num-flash"),e>=0&&setTimeout(function(){t.photos.basket_animate(e-1)},200)},add_to_basket:function(){t(".basket-add").click(function(){n=t(".photo-preview").attr("value"),p_id=t(".thumb").eq(n).children(".p-id").length>0?t(".thumb").eq(n).children(".p-id").html():t("#photo-id").html();var e=t("<div />").addClass("type-selection-box");e.html(t("#type-selection").html()),e.dialog({resizable:!1,draggable:!1,modal:!0,title:"Type Selection",buttons:{Ok:function(){t.ajax({type:"POST",url:script_url+"photos/add_basket",data:{photo_id:p_id,type:e.find(".type-select").val()},error:function(){e.dialog("close"),t.common.notify("This photo could not be added to your basket")},success:function(){e.dialog("close"),t.photos.closeScreen(),t.photos.load_basket(!0)}})},Cancel:function(){t(this).dialog("close")}}})})},load_basket:function(e){t.ajax({type:"POST",url:script_url+"photos/basket",data:{update:1},error:function(){t.common.notify("Something went wrong...")},success:function(o){t(".basket-preview").html(JSON.parse(o).html),t(".basket-preview h2").click(function(){t(this).parent().hasClass("basket-open")?t(".basket-contents").animate({height:"0px"},function(){t(this).parent().removeClass("basket-open")}):(t(this).parent().addClass("basket-open"),h=t(".basket-contents").css("height","auto").height(),t(".basket-contents").css("height","0px"),t(".basket-contents").animate({height:h+"px"}))}),t(".update-cart").click(function(e){e.preventDefault(),t.photos.update_totals()}),e&&t.photos.basket_animate(4)}})},update_totals:function(){ids=[],vals=[],t(".basket-qty").each(function(){ids.push(t(this).siblings(".row-id").html()),vals.push(t(this).val())}),t.ajax({type:"POST",url:script_url+"photos/update_basket",data:{ids:ids,vals:vals},error:function(){t.common.notify("Sorry, we couldn't update the basket at the moment.")},success:function(){t(".large-photo").length>0?location.reload():t.photos.load_basket()}})},start_tag:function(){t(".tag").addClass("untag"),t(".photo-preview-container").addClass("tagging"),t("<a/>").html("<p>Stop Tagging</p>").attr("href","#").addClass("stop-tagging").prependTo("<p/>").click(function(){t.photos.end_tag()}).appendTo(".tagged-info"),setTimeout(function(){t(".photo-preview").click(function(e){t.photos.tag_image(e)})},200)},end_tag:function(){t(".tag").removeClass("untag"),t(".stop-tagging, .tag-box").remove(),t(".photo-preview-container").removeClass("tagging"),t(".photo-preview").unbind("click"),t(".name-input").parent().remove()},tag_image:function(e){t(".tag-box").remove(),t(".name-input").parent().remove(),t(this).attr("x",e.offsetX),t(this).attr("y",e.offsetY),o=t(".photo-preview").offset(),x=t.photos.screen_to_db_x(e.pageX-o.left),y=t.photos.screen_to_db_y(e.pageY-o.top),cX=t.photos.db_to_screen_x(x),cY=t.photos.db_to_screen_y(y),box=t("<div/>").addClass("tag-box").appendTo(".photo-preview"),box.css("top",cY-box.height()/2),box.css("left",cX-box.width()/2),paragrah=t("<p/>").appendTo(".tagged-info"),t("<input>").addClass("name-input").attr("placeholder","Type a Name...").appendTo(paragrah).focus();var a=[];t("#list-of-users").children("p").each(function(){a.push({value:t(this).text(),id:t(this).attr("value")})}),t(".name-input").autocomplete({source:a,select:function(e,o){null==o.item||(n=t(".photo-preview").attr("value"),t.ajax({type:"POST",url:script_url+"photos/add_tag",data:{x:x,y:y,u_id:o.item.id,p_id:t(".thumb").eq(n).children(".p-id").html()},error:function(){t.common.notify("Sorry, something went wrong, could you reload the page?")},success:function(){t("<p/>").attr("value",o.item.id).attr("x",x).attr("y",y).html(o.item.label).appendTo(".side-bar .list-of-tagged"),t("<p/>").attr("value",o.item.id).attr("x",x).attr("y",y).html(o.item.label).appendTo(t(".thumb").eq(n).find(".list-of-tagged")),t.photos.hover_remove(),t(".name-input").parent().remove(),t(".tag-box").remove()}}))}})},hover_remove:function(){t(".list-of-tagged").children("p").mouseover(function(){t.photos.show_tag(t(this))}).mouseout(function(){t.photos.hide_tag()})},show_tag:function(e){t(".tag-name").attr("value")!=e.attr("value")&&(0==t(".tag-name").length&&(t("<div/>").addClass("tag-name").appendTo(".photo-preview"),t("<div/>").addClass("tag-name-arrow").prependTo(".tag-name"),t("<div/>").addClass("tag-name-text").appendTo(".tag-name")),t(".tag-name-text").html(e.html()),t(".tag-name").show(),t(".tag-name").css("left",t.photos.db_to_screen_x(parseFloat(e.attr("x")))-t(".tag-name").width()/2),t(".tag-name").css("top",t.photos.db_to_screen_y(parseFloat(e.attr("y")))),t(".tag-name").attr("value",e.attr("value")))},hide_tag:function(){t(".tag-name").hide(),t(".tag-name").attr("value","")},db_to_screen_x:function(e){return n=t(".photo-preview").attr("value"),w=t(".thumb").eq(n).children(".width").html(),h=t(".thumb").eq(n).children(".height").html(),r=w/h,r>1?5*e:5*r*e+250-250*r},db_to_screen_y:function(e){return n=t(".photo-preview").attr("value"),w=t(".thumb").eq(n).children(".width").html(),h=t(".thumb").eq(n).children(".height").html(),r=w/h,r>1?5*e/r+250-250/r:5*e},screen_to_db_x:function(e){return n=t(".photo-preview").attr("value"),w=t(".thumb").eq(n).children(".width").html(),h=t(".thumb").eq(n).children(".height").html(),r=w/h,r>1?Math.min(Math.max(e/5,0),100):Math.min(Math.max(e/(5*r)-50/r+50,0),100)},screen_to_db_y:function(e){return n=t(".photo-preview").attr("value"),w=t(".thumb").eq(n).children(".width").html(),h=t(".thumb").eq(n).children(".height").html(),r=w/h,r>1?Math.min(Math.max(e*r/5-50*r+50,0),100):Math.min(Math.max(e/5,0),100)}}}(jQuery);